# 安装并加载 pheatmap 套件
if (!requireNamespace("pheatmap", quietly = TRUE)) install.packages("pheatmap")
library(pheatmap)

# 读取数据
bin_data <- read.table("GSE99106_nm_none_10000.bins.txt", header = TRUE, sep = "\t")

# 检查数据结构
str(bin_data)
head(bin_data)

# 筛选特定染色体的数据（例如 "chr2L"）
specific_chr <- "2L"
filtered_data <- bin_data[bin_data$chr == specific_chr, ]

# 检查筛选后的数据
if (nrow(filtered_data) == 0) {
  stop("No data found for the specified chromosome.")
}

# 提取唯一的 bin ID
bin_ids <- unique(filtered_data$cbin)

# 检查 bin ID 数量
if (length(bin_ids) <= 1) {
  stop("Not enough bins to generate a meaningful heatmap.")
}

# 初始化一个零矩阵
hic_matrix <- matrix(0, nrow = length(bin_ids), ncol = length(bin_ids))

# 为矩阵添加行名和列名
rownames(hic_matrix) <- bin_ids
colnames(hic_matrix) <- bin_ids

# 填充矩阵
for (i in 1:nrow(filtered_data)) {
  bin_row <- as.character(filtered_data$cbin[i])
  bin_col <- as.character(filtered_data$cbin[i])  # 假设数据是对称的
  hic_matrix[bin_row, bin_col] <- filtered_data$count[i]
}

# 检查矩阵是否为空
if (all(hic_matrix == 0)) {
  stop("The Hi-C matrix is empty or contains only zeros.")
}

# 对矩阵进行对数变换
log_hic_matrix <- log2(hic_matrix + 1)

# 添加示例注释轨迹（模拟功能域）
annotation_data <- data.frame(
  Region = c("Domain1", "Domain2", "Domain3"),
  Type = c("Red", "Blue", "Black")
)
rownames(annotation_data) <- bin_ids[1:3]  # 假设前 3 个 bin 对应功能域

# 设置注释颜色
annotation_colors <- list(
  Type = c(Red = "red", Blue = "blue", Black = "black")
)

# 绘制热图
pheatmap(log_hic_matrix, 
         color = colorRampPalette(c("white", "blue", "red"))(100), 
         main = paste("Hi-C Heatmap for", specific_chr),
         annotation_row = annotation_data,
         annotation_colors = annotation_colors,
         cluster_rows = FALSE,
         cluster_cols = FALSE)

# 保存热图为文件
output_file <- "hic_heatmap_chr2L.png"
png(output_file, width = 800, height = 800)
pheatmap(log_hic_matrix, 
         color = colorRampPalette(c("white", "blue", "red"))(100), 
         main = paste("Hi-C Heatmap for", specific_chr),
         annotation_row = annotation_data,
         annotation_colors = annotation_colors,
         cluster_rows = FALSE,
         cluster_cols = FALSE)
dev.off()

cat("Hi-C heatmap saved to:", output_file, "\n")
